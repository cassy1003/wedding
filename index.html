<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Wedding After Party Information</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Takahiro and Akari's wedding After party Information">
<meta name="keywords" content="">
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/style.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body>
  <img src="images/bg1.png" class="kazari">
  <img src="images/kusa.png" class="kazari kazari-bg">

  <div id="sub">
    <div class="logo normal"><img src="images/wedding_after_party.png"></div>
    <div class="logo small"><img src="images/wedding_after_party_s.png"></div>
    <p class="countdown"></p>
  </div>

  <p id="form_open"><a onclick="$('body').addClass('form');return false;">出欠フォーム</a></p>

  <div id="main">
    <div id="save-the-date" class="contents">
      <img src="images/save_the_date_pin.png">
    </div>
    <div id="announce" class="black_board contents">
      <div class="bg">
        <img src="images/shell1.png" id="shell1">
        <img src="images/shell2.png" id="shell2">
        <img src="images/starfish.png" id="starfish">
      </div>
      <section>
        <h1>結婚披露パーティーのお知らせ</h1>
        <p>突然のご報告ではありますが、</p>
        <p>私たち柏木隆宏と杉山明里は、この度結婚することになりました。</p>
        <p>つきましては、ささやかではございますが、<br class="not_sp_s">
           皆様をお招きして結婚披露パーティーを開催したいと思います。</p>
        <p>是非ご参加いただけますようお願いいたします。</p>
      </section>
    </div>
    <div id="detail" class="black_board contents">
      <div class="bg">
        <img src="images/sunglass.png" id="sunglass">
        <img src="images/drink1.png" id="drink1">
        <img src="images/drink2.png" id="drink2">
      </div>
      <section>
        <h1>パーティー詳細</h1>
        <p class="title">日時</p>
        <p class="u red">2017.07.22(土)</p>
        <p>受付開始 17:00 <br class="sp"> (開宴 17:30 | 終宴 19:30)</p>
        <p class="title">場所</p>
        <p>東京都千代田区有楽町1-5-2 <br class="sp"> 東宝ツインタワービル地下</p>
        <p class="u red">Club DIANA</p>
        <p>東京メトロ <br class="sp_s">日比谷駅 A5出口付近</p>
        <p><span class="not_sp_s">東京メトロ </span>銀座駅 C1出口より徒歩3分</p>
        <p>JR <br class="sp_s">有楽町駅 日比谷口より徒歩3分</p>
        <p class="title">会費</p>
        <p>7000円</p>
      </section>
    </div>

    <p class="form_name">参加確認フォーム</p>
    <div class="form">
      <div class="form_contents">
        <div class="form_wrap">
          <form action="https://script.google.com/macros/s/AKfycbzIIEPV_mv1Bk-jA12ZHXZk49T_-3_92YuMVbGBSVwl273pSlQ/exec" onsubmit="test(this);return false;">
            <input type="hidden" name="SPREADSHEET_ID" value="1Mp914nCYkcETazdRYvJistSHr7J324AOguTvHv4vm4Q">
            <input type="hidden" name="SHEET_NAME" value="参加フォーム">
            <div class="btn-group" data-toggle="buttons">
              <label class="btn btn-default">
                <input name="join" value="true" type="radio" checked="checked">参加
                <img src="images/maru_2.png" class="check_maru maru_1">
              </label>
              <label class="btn btn-default">
                <input name="join" value="false" type="radio">不参加
                <img src="images/maru_2.png" class="check_maru maru_2">
              </label>
              <label class="btn btn-default">
                <input name="join" value="pending" type="radio">保留
                <img src="images/maru_2.png" class="check_maru maru_3">
              </label>
            </div>
            <label for="name">お名前 (ニックネーム): </label>
            <input type="text" name="name" value="" id="name" required />
            <label for="email">連絡先 (LINE or EMAIL): </label>
            <input type="text" name="email" value="" id="email" required />
            <label for="email">メッセージ (何でもお書きください): </label>
            <textarea  name="message" value="Your Message" id="message" required ></textarea>
            <input type="submit" name ="submit" value="Send Message!" />
          </form>
        </div>
        <script>
          function test(form) {
            $.ajax({
              type: 'POST',
              url: $(form).attr('action'),
              data: $(form).serialize(),
              dataType: 'jsonp'
            });
            return false;
          }
        </script>
      </div>
    </div>

    <div id="upload" class="form">
      <div class="form_contents">
        <div class="form_wrap">
          <form id="form" action="upload.php" method="POST" enctype="multipart/form-data">
          <!-- form id="form" action="https://script.google.com/macros/s/AKfycbxbmjY3fTQwSge9hpsaIhPfLJTk6SI4a82Uqt4ge5KxAAEEAsA/exec" onsubmit="sendfiles(this);return false;" -->
            <label for="name">お名前: </label>
            <input type="text" name="name" value="" id="name" />
            <label for="name">画像: </label>
            <input type="file" name="image" value="" id="image" accept="image/*" />
            <label for="email">メッセージ: </label>
            <textarea  name="message" value="Your Message" id="message" ></textarea>
            <input type="submit" name ="submit" value="Send Message!" />
          </form>
        </div>
        <script>
          function test2(form) {
            $.ajax({
              type: 'POST',
              url: $(form).attr('action'),
              data: $(form).serialize(),
              dataType: 'jsonp'
            });
            return false;
          }
        </script>
      </div>
    </div>

  </div>

  <!-- footer>
  </footer -->


  <script>
  $(function(){
    // カウントダウン
    var count = Math.ceil( (new Date('2017/07/22') - new Date()) / (24*60*60*1000) );
    $('.countdown').html('あと ' + count + '日');
  });
  </script>

  <script>
    //グローバル変数
    var dufname = "";      //画像ファイル名を格納する
    var dataUrl = "";      //画像ファイルデータを格納する

    function sendfiles(form){
      //基礎データ用の配列を用意
      var upfile = [];
      //var validata = "";

      //基礎データをpushする
      //validata = document.getElementById("folder").value;
      //if(validata == ""){
      //  alert("アップ先フォルダのIDが入っていませんよ。");
      //  document.getElementById("folder").focus();
      //  return 0;
      //}else{
      //  upfile.push(validata);
      //}

      //ファイル名とデータを格納する
      upfile.push(dataUrl);
      upfile.push(dufname);

      //GAS側へデータを送る
      //google.script.run.withSuccessHandler(retmsg).uploadman(upfile);
      console.log($(form).attr('action'));
      console.log(dataUrl.split(',')[1]);
      $.ajax({
        type: 'POST',
        url: $(form).attr('action'),
        data: 'image='+dufname,//dataUrl.split(',')[1],
        dataType: 'jsonp'
      });
      return false;

      //プログレス表記に変える
      //document.getElementById("mainform").style.display="none";
      //document.getElementById("progress").style.display="block";

    }

    //サーバー側からのメッセージを表示
    function retmsg(data){
      //データを受け取る
      var json = JSON.parse(data);

      //ステータスに応じて処理を分岐
      if(json[0] == "OK"){
        document.getElementById("progress").innerHTML = json[1];
      }else{
        //プログレス表記を終了する
        document.getElementById("mainform").style.display="block";
        document.getElementById("progress").style.display="none"; 
        alert(json[1]);
      }
    }

    //画像ファイル選択時にイベントを実行する
    $(function($) {
      $('#image').change(function(e) {
        var file = e.target.files[0];
        dufname = file.name;
        var reader = new FileReader();
        //ファイルの読込が終了した時の処理
        reader.onload = function(){
          dataUrl = reader.result;
        }
        reader.readAsDataURL(file)
      });
    },false);
  </script>

  <script src="https://apis.google.com/js/client.js"></script>
  <script>
    var googleDriveClient;
    getGoogleAuth().then(loadGoogleDrive).then(function(gClient){
        googleDriveClient = gClient;
    });

    // google driveのクライアントの生成
    function loadGoogleDrive() {
      var p = new Promise(function(resolve, reject) {
        try {
          window.gapi.client.load('drive', 'v3', fncOnDriveApiLoad);
        } catch (e) {
          reject(e);
        }
        function fncOnDriveApiLoad() {
          resolve(window.gapi.client);
        }
      });
      return p;
    }

    // Google認証
    function getGoogleAuth() {
      var objAuthParam = {
        // クライアントIDはGoogle API consoleで取得してください
        'client_id': '655079260460-ea8979mmtse9gdg5ifi7g99h3p2tfm8k.apps.googleusercontent.com',
        'scope': ['https://www.googleapis.com/auth/drive'],
        'immediate': false
      };
      var p = new Promise(function(resolve, reject) {
          window.gapi.load('auth', {
              'callback': function () {
                  window.gapi.auth.authorize(
                      objAuthParam,
                      authResult);
              }
          });
          function authResult(objAuthResult) {
              if (objAuthResult && !objAuthResult.error) {
                  resolve(objAuthResult.access_token);
              } else {
                  // auth failed.
                  reject(objAuthResult);
              }
          }
      });
      return p;
    }

    // ファイルアップロード
    function uploadFile(gClient, base64FileData, fileName, fileType) {
        // 固定文
        const boundary = '-------314159265358979323846';
        const delimiter = '\r\n--' + boundary + '\r\n';
        const closeDelim = '\r\n--' + boundary + '--';
        const contentType = fileType;

        // アップロード先のフォルダ指定など
        var metadata = {
            'name': fileName,
            'mimeType': contentType
        };
        var multipartRequestBody =
            delimiter +
            'content-type: application/json; charset=UTF-8\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'content-transfer-encoding: base64\r\n' +
            'content-type: ' + contentType + '\r\n\r\n' +
            base64FileData +
            closeDelim;
        var request = gClient.request({
            'path': '/wedding',
            'method': 'POST',
            'params': {
                'uploadType': 'multipart'
            },
            'headers': {
                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
            },
            'body': multipartRequestBody
        });
        try {
            request.execute(function (objFile) {
                console.log(objFile);
                console.info('upload success !');
            });
        } catch (e) {
            console.error(e);
        }
    }

    function upload(form) {
      var file = $(form).find('input[name=image]').prop('files')[0];
      console.log(file.name);
      var reader = new FileReader();
      reader.onload = function(e) {
        // base64データのデータ本部を抽出
        var arraySplitBase64 = reader.result.split(',');
        // file upload
        //uploadFile(googleDriveClient, arraySplitBase64[1], file.name, file.type);
      };
      reader.readAsDataURL(file);
    }

    // ドロップした時のイベント
    function drop(event) {
      if (event.dataTransfer && event.dataTransfer.files instanceof FileList && event.dataTransfer.files.length > 0) {
        // サンプルとして1ファイルのみとする
        var file = event.dataTransfer.files[0];
        var reader = new FileReader();
        // バイナリファイルをbase64に変換
        reader.readAsDataURL(file);
        reader.onload = function(e) {
          var arraySplitBase64 = '';
          if (typeof reader.result === 'string') {
            // base64データのデータ本部を抽出
            arraySplitBase64 = reader.result.split(',');
            // file upload
            uploadFile(googleDriveClient, arraySplitBase64[1], file.name, file.type);
          } else {
            throw 'read file error';
          }
        };
      }
      event.preventDefault();
    }
  </script>

</body>
</html>
